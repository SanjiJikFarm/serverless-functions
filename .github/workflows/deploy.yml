name: Deploy to Naver Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "serverless.yml"
      - "package.json"
      - "package-lock.json"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Install Serverless Framework
        run: npm install -g serverless@3

      - name: Install serverless-navercloud plugin
        run: npm install serverless-navercloud

      - name: Set environment variables
        env:
          NCLOUD_ACCESS_KEY_ID: ${{ secrets.NCLOUD_ACCESS_KEY_ID }}
          NCLOUD_SECRET_KEY: ${{ secrets.NCLOUD_SECRET_KEY }}
          CLOVA_OCR_SECRET: ${{ secrets.CLOVA_OCR_SECRET }}
          CLOVA_OCR_URL: ${{ secrets.CLOVA_OCR_URL }}
          NCP_BUCKET: ${{ secrets.NCP_BUCKET }}
          NCP_REGION: ${{ secrets.NCP_REGION }}
        run: echo "환경변수 세팅 완료"

      - name: Deploy with Serverless Framework
        run: serverless deploy
